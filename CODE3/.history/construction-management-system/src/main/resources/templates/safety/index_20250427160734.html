<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>安全监控记录管理</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        .severity-high {
            color: #dc3545;
            font-weight: bold;
        }
        .severity-medium {
            color: #ffc107;
            font-weight: bold;
        }
        .severity-low {
            color: #28a745;
        }
        .status-pending {
            color: #6c757d;
        }
        .status-processing {
            color: #17a2b8;
        }
        .status-resolved {
            color: #28a745;
        }
        .status-closed {
            color: #6c757d;
            text-decoration: line-through;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col">
                <h2>安全监控记录管理</h2>
            </div>
            <div class="col text-end">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#safetyRecordModal" id="createRecordBtn">
                    <i class="bi bi-plus-circle"></i> 新建安全记录
                </button>
            </div>
        </div>

        <!-- 搜索表单 -->
        <div class="card mb-4">
            <div class="card-body">
                <form th:action="@{/safety/search}" method="get" class="row">
                    <div class="col-md-2 mb-3">
                        <label for="workerId">工人ID</label>
                        <input type="number" class="form-control" id="workerId" name="workerId">
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="projectId">项目ID</label>
                        <input type="number" class="form-control" id="projectId" name="projectId">
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="eventType">事件类型</label>
                        <select class="form-control" id="eventType" name="eventType">
                            <option value="">全部</option>
                            <option value="安全帽未戴">安全帽未戴</option>
                            <option value="违规操作">违规操作</option>
                            <option value="设备故障">设备故障</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="severityLevel">严重程度</label>
                        <select class="form-control" id="severityLevel" name="severityLevel">
                            <option value="">全部</option>
                            <option value="低">低</option>
                            <option value="中">中</option>
                            <option value="高">高</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="status">处理状态</label>
                        <select class="form-control" id="status" name="status">
                            <option value="">全部</option>
                            <option value="待处理">待处理</option>
                            <option value="处理中">处理中</option>
                            <option value="已处理">已处理</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="location">位置</label>
                        <input type="text" class="form-control" id="location" name="location">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="startTime">开始时间</label>
                        <input type="datetime-local" class="form-control" id="startTime" name="startTime">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="endTime">结束时间</label>
                        <input type="datetime-local" class="form-control" id="endTime" name="endTime">
                    </div>
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-primary">搜索</button>
                        <a th:href="@{/safety/new}" class="btn btn-success">新建记录</a>
                    </div>
                </form>
            </div>
        </div>

        <!-- 记录列表 -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>工人ID</th>
                                <th>项目ID</th>
                                <th>事件类型</th>
                                <th>严重程度</th>
                                <th>发生时间</th>
                                <th>位置</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="record : ${records}">
                                <td th:text="${record.id}"></td>
                                <td th:text="${record.workerId}"></td>
                                <td th:text="${record.projectId}"></td>
                                <td th:text="${record.eventType}"></td>
                                <td>
                                    <span th:class="${'badge badge-' + 
                                        (record.severityLevel == '高' ? 'danger' : 
                                         record.severityLevel == '中' ? 'warning' : 'info')}"
                                          th:text="${record.severityLevel}">
                                    </span>
                                </td>
                                <td th:text="${#temporals.format(record.occurrenceTime, 'yyyy-MM-dd HH:mm')}"></td>
                                <td th:text="${record.location}"></td>
                                <td>
                                    <span th:class="${'badge badge-' + 
                                        (record.status == '待处理' ? 'danger' : 
                                         record.status == '处理中' ? 'warning' : 'success')}"
                                          th:text="${record.status}">
                                    </span>
                                </td>
                                <td>
                                    <a th:href="@{/safety/{id}/edit(id=${record.id})}" class="btn btn-sm btn-primary">
                                        <i class="bi bi-pencil"></i> 编辑
                                    </a>
                                    <button type="button" class="btn btn-sm btn-danger" 
                                            th:onclick="'deleteRecord(' + ${record.id} + ')'">
                                        <i class="bi bi-trash"></i> 删除
                                    </button>
                                    <a th:href="@{/safety/{id}/details(id=${record.id})}" class="btn btn-sm btn-info">
                                        <i class="bi bi-info-circle"></i> 详情
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 分页 -->
                <nav th:if="${records.totalPages > 1}">
                    <ul class="pagination justify-content-center">
                        <li class="page-item" th:classappend="${records.first ? 'disabled' : ''}">
                            <a class="page-link" th:href="@{${'/safety/search'}(page=${records.number - 1}, size=${records.size}, ${params})}">上一页</a>
                        </li>
                        <li class="page-item" th:each="i : ${#numbers.sequence(0, records.totalPages - 1)}"
                            th:classappend="${records.number == i ? 'active' : ''}">
                            <a class="page-link" th:href="@{${'/safety/search'}(page=${i}, size=${records.size}, ${params})}" th:text="${i + 1}"></a>
                        </li>
                        <li class="page-item" th:classappend="${records.last ? 'disabled' : ''}">
                            <a class="page-link" th:href="@{${'/safety/search'}(page=${records.number + 1}, size=${records.size}, ${params})}">下一页</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- 安全记录模态框 -->
    <div class="modal fade" id="safetyRecordModal" tabindex="-1" aria-labelledby="safetyRecordModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="safetyRecordModalLabel">安全记录</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="safetyRecordForm">
                        <input type="hidden" id="recordId">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="modalWorkerId" class="form-label">工人ID</label>
                                <input type="number" class="form-control" id="modalWorkerId" required>
                            </div>
                            <div class="col-md-6">
                                <label for="modalProjectId" class="form-label">项目ID</label>
                                <input type="number" class="form-control" id="modalProjectId" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="modalEventType" class="form-label">事件类型</label>
                                <select class="form-select" id="modalEventType" required>
                                    <option value="违规操作">违规操作</option>
                                    <option value="安全隐患">安全隐患</option>
                                    <option value="事故">事故</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="modalSeverityLevel" class="form-label">严重程度</label>
                                <select class="form-select" id="modalSeverityLevel" required>
                                    <option value="一般">一般</option>
                                    <option value="严重">严重</option>
                                    <option value="特别严重">特别严重</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="modalOccurrenceTime" class="form-label">发生时间</label>
                                <input type="datetime-local" class="form-control" id="modalOccurrenceTime" required>
                            </div>
                            <div class="col-md-6">
                                <label for="modalLocation" class="form-label">地点</label>
                                <input type="text" class="form-control" id="modalLocation" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="modalDescription" class="form-label">事件描述</label>
                            <textarea class="form-control" id="modalDescription" rows="3" required></textarea>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="modalStatus" class="form-label">状态</label>
                                <select class="form-select" id="modalStatus" required>
                                    <option value="待处理">待处理</option>
                                    <option value="处理中">处理中</option>
                                    <option value="已处理">已处理</option>
                                    <option value="已关闭">已关闭</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="modalHandler" class="form-label">处理人</label>
                                <input type="text" class="form-control" id="modalHandler">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="modalHandleTime" class="form-label">处理时间</label>
                                <input type="datetime-local" class="form-control" id="modalHandleTime">
                            </div>
                            <div class="col-md-6">
                                <label for="modalResult" class="form-label">处理结果</label>
                                <input type="text" class="form-control" id="modalResult">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="modalMeasures" class="form-label">处理措施</label>
                            <textarea class="form-control" id="modalMeasures" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="modalRemarks" class="form-label">备注</label>
                            <textarea class="form-control" id="modalRemarks" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveRecordBtn">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 查看详情模态框 -->
    <div class="modal fade" id="viewRecordModal" tabindex="-1" aria-labelledby="viewRecordModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewRecordModalLabel">安全记录详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>ID:</strong> <span id="viewId"></span></p>
                            <p><strong>工人ID:</strong> <span id="viewWorkerId"></span></p>
                            <p><strong>项目ID:</strong> <span id="viewProjectId"></span></p>
                            <p><strong>事件类型:</strong> <span id="viewEventType"></span></p>
                            <p><strong>严重程度:</strong> <span id="viewSeverityLevel"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>发生时间:</strong> <span id="viewOccurrenceTime"></span></p>
                            <p><strong>地点:</strong> <span id="viewLocation"></span></p>
                            <p><strong>状态:</strong> <span id="viewStatus"></span></p>
                            <p><strong>处理人:</strong> <span id="viewHandler"></span></p>
                            <p><strong>处理时间:</strong> <span id="viewHandleTime"></span></p>
                        </div>
                    </div>
                    <div class="mb-3">
                        <p><strong>事件描述:</strong></p>
                        <div class="p-2 bg-light rounded" id="viewDescription"></div>
                    </div>
                    <div class="mb-3">
                        <p><strong>处理措施:</strong></p>
                        <div class="p-2 bg-light rounded" id="viewMeasures"></div>
                    </div>
                    <div class="mb-3">
                        <p><strong>处理结果:</strong> <span id="viewResult"></span></p>
                    </div>
                    <div class="mb-3">
                        <p><strong>备注:</strong></p>
                        <div class="p-2 bg-light rounded" id="viewRemarks"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="editFromViewBtn">编辑</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除确认对话框 -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">确认删除</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    确定要删除这条安全监控记录吗？此操作不可恢复。
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">删除</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script th:inline="javascript">
        function deleteRecord(id) {
            $('#deleteModal').modal('show');
            $('#confirmDelete').off('click').on('click', function() {
                $.ajax({
                    url: '/safety/' + id,
                    type: 'DELETE',
                    success: function() {
                        location.reload();
                    },
                    error: function(xhr) {
                        alert('删除失败：' + xhr.responseText);
                    }
                });
            });
        }
    </script>
</body>
</html> 